---
layout: "../../layouts/BlogPost.astro"
title: "VimをRStudioのように設定する"
pubDate: "2021/10/10"
heroImage: "/lab/member/2109/images/nvim-r-oneline.PNG"
description: "Nvim-Rというプラグインについて紹介"
---

## 導入
皆さん御存知の通り、知らなくてもこの記事で知っていただけると嬉しいのだが、私は
[Vim](https://www.vim.org/)というテキストエディタを半年ほど前から愛用している。
Linuxかあるいはその他UnixライクなOSを使用したことがある人ならどこかの機械で使用
したことがあるかもしれないが、以下のような特徴を持っている。

### ターミナル上で動作する
GUIを持つバージョン(gvimと呼ばれる)もあるが、こちらを好んで使うVimmerはあまりい
ないと思う。

### すべての操作をキーボードで完結させる
世の中の立地なGUIを持つアプリケーションは、「業務の効率化ができる」と題して
ショートカットキーを備えていることが多い。しかし、それは単なる「ショートカッ
ト」であり、本来想定された操作に対して付け焼刃的なオルタナティブを提供している
に過ぎない。Vimの操作体系はショートカットではなく、「キーバインディング」と呼ば
れるべきものであり、この操作こそが本来想定されたUIなのだ。

### 拡張性が(比較的)高い
Vimが拡張性が高いとあんまり吹聴してしまうと、Emacsユーザから容赦なくディスられ
てしまうので、それは言わない。また、マイクロソフトのエコシステムと組み合わせた
場合に限る拡張性を広く宣伝しているVS Codeという存在もなかなか厄介なので、それも
考慮してこのようなことはあまり言わない。

私が言いたいのは、拡張性が高いだけでなく、スケーラビリティが高いということ。Vim
ユーザの中には、数十のプラグインを入れてあらゆる操作をVim上で完結させるまでに高
めた人もいれば、vimrcに設定をあまり長々と記述せず、プラグインも入れず、そのかわ
りに卓越したUNIXコマンドやLinuxコマンドを駆使して同等の生産性を示すスパルタン
Vimmerまで広く存在する (誰のことかって？ [そんなこと、言わなくてもわかるだろう](https://www.kaoriya.net))

ここまで述べた特徴はVim歴の比較的浅い私が30秒くらいで適当にまとめたものであり、
実際には様々な利点が隠されている。Vimに興味がある方はぜひとも使ってみよう！

## RStudioについて
話は変わって、ここからRおよびRStudioについてちょっと話したい。

### RStudioのメリット
データ分析に用いるツールは何が良いのか、という話が古くから言われている。私は比
較的Pythonが手に馴染んでいるので、ゼミの研究でもその他のデータ分析実習でも
Pythonを用いて進めてきた。しかし、DS学部で生きていくためには、もう一方のメ
ジャーツールであるRも使いこなせるようになる必要がある。実際、必修の授業の中に
は、嫌でもRに親しまなければならないシーンが多々ある。

Rを使うとき、君たちはどこにそのソースコードを書いているだろうか。もちろんそれは
RStudioだろう。

RStudioは、RのIDEとしては非常に完成度が高い。ワークスペースに作成された変数はす
ぐとなりに表示されるし、グラフィックも同じ画面に表示されるし、フォントも見やす
いし、RのソースファイルだけでなくRMarkdownやStanを作成したいときにもすべて
RStudioで作業を進めることができる。

Pythonがデータ分析以外の様々なタスク (シェルスクリプトの代替、ウェブアプリ) に
用いられるのに対して、Rの環境はデータ分析に特化している。NumpyやPandasなどで無
理やり拡張されたPythonとは、環境構築の快適度が全く違うだろう。

### RStudioのデメリット
そんなRStudioには唯一つ、どうしようもないデメリットがある。それは、**編集画面の
UIがVimではないこと**だ。

実にお門違いな指摘かもしれない。だがこれはVimmerにとっては死活問題。`hjkl`で移
動できないし`/`で検索もできない。さらには別のファイルを編集するのにCtrl+wによる
軽やかなステップも踏めない。Vim以外のあらゆるツールの最大の欠点はVimではないこ
とにほかならないのだ。

## Nvim-R
上記のような悩みを解決するのが、Nvim-Rというプラグインである。

[jalvesaq/Nvim-R](https://github.com/jalvesaq/Nvim-R)

いつもの方法でRをPCにインストールして、次にプラグインマネージャを利用してこの
Nvim-RをVimにインストールする。インストールすると、自動的にNvim-Rが立ち上がっ
て、インストールしたR環境を認識してくれる。Nvim-RがRを操作するためには、いくつ
かの依存が必要になるが、基本的にNvim-Rが自動的にセットアップしてくれる。

### RをVimから起動する
インストールが完了したら、早速Rファイルを開いたり何なりして、動かす準備をする。

基本的な使い方として、Vimで開いているソースファイルの一部や全部をRに送って、そ
の実行結果を表示するという流れになる。RをVimから起動するには、`<LocalLeader>rf`
を押す。Vimの++terminal機能を使ってデフォルトの端末アプリが起動し、そこからRが
起動する。表示される画面はWindowsならRGui、Linuxなら`R`を起動したときのコマンド
待機画面になる。

![Nvim-Rの起動](/lab/member/2109/images/nvim-r-screenshot.PNG)

### Rにコマンドを送信する
どうやら技術的にはTCP用いてRにコマンドを送信しているようである。ユーザーの立場
としてはそのようなことを気にする必要はまったくないので、`<LocalLeader>aa`でバッ
ファにある全ての行をRに送信して実行させよう。上の画面では定番のirisデータセット
を用いて回帰分析をしようとしている。

`<LocalLeader>l`を使うと今カーソルがある行を実行することができる。Jupyter
Notebookみたいに、打ち込んだ命令をその場で確認できるのでなかなか便利だ。

![一行だけ実行する](/lab/member/2109/images/nvim-r-oneline.PNG)

`help`や`?`を実行するとブラウザが立ち上がる。RStudioやRGuiと挙動は同じだ。これ
をLinuxでやるとVim内でバッファが開いて、そこにRのローカルドキュメントが表示され
る。個人的にはVimのバッファで表示されたほうが見やすくて便利なので、Windowsでも
そのようにしてほしいのだが。

グラフィックは、別ウィンドウが開いてそこにグラフなどが表示される。VimはEmacsと
違ってグラフィック処理はできないので、こればかりは仕方なかろう。

コマンドを送信するだけでなく、表示されたターミナルエミュレータに直接コマンドを
送ることもできる。

その他多くのキーバインディングが予め設定されているので、詳しい使い方は`:h
nvim-r-use`を参照しよう。

## まとめ

* あらゆるIDE、エディタの最大の欠点は**Vimでないこと**
* Nvim-Rを導入することで、Vimの操作感のままRを利用することができる

これでRの実習が到来しても安心できる。そんな私は現在、Jupyter NotebookにVimの操
作を導入する方法が知りたい。
